# ğŸ” Auth Gate å¯¦ç¾æ–‡æª”

## ğŸ“‹ æ”¹å‹•æª”æ¡ˆæ¸…å–®

### ä¿®æ”¹æª”æ¡ˆ
1. **`apps/mobile/src/lib/auth.ts`**
   - æ–°å¢ `getSession()`: ç²å–ç•¶å‰ Session
   - æ–°å¢ `requireAuth(nextRoute: string)`: è¦æ±‚ç™»å…¥ï¼Œæœªç™»å…¥æ™‚å°å‘ç™»å…¥é ä¸¦ä¿å­˜ç›®æ¨™è·¯ç”±

2. **`apps/mobile/app/create.tsx`**
   - åœ¨ `handleSubmit()` ä¸­ä½¿ç”¨ `requireAuth('/create')` æª¢æŸ¥ç™»å…¥ç‹€æ…‹
   - æœªç™»å…¥æ™‚è‡ªå‹•å°å‘ç™»å…¥é ï¼Œç™»å…¥å¾Œå›åˆ° `/create`

3. **`apps/mobile/app/wish/[id]/reply.tsx`**
   - åœ¨ `handleSubmit()` ä¸­ä½¿ç”¨ `requireAuth(`/wish/${id}/reply`)` æª¢æŸ¥ç™»å…¥ç‹€æ…‹
   - æœªç™»å…¥æ™‚è‡ªå‹•å°å‘ç™»å…¥é ï¼Œç™»å…¥å¾Œå›åˆ°å›è¦†é 

4. **`apps/mobile/app/login.tsx`**
   - ç™»å…¥æˆåŠŸå¾Œè‡ªå‹•å°èˆªåˆ° `next` åƒæ•¸æŒ‡å®šçš„è·¯ç”±
   - è‹¥æ²’æœ‰ `next` åƒæ•¸ï¼Œå°èˆªåˆ°é¦–é 
   - ç§»é™¤ç™»å…¥æˆåŠŸçš„ Alertï¼Œæ”¹ç‚ºç›´æ¥å°èˆªï¼ˆæ›´æµæš¢çš„é«”é©—ï¼‰

## ğŸ”„ æµç¨‹åœ–

### å ´æ™¯ 1ï¼šæœªç™»å…¥ç”¨æˆ¶é»æ“Šã€Œå‰µå»ºè¨±é¡˜å–®ã€

```
ç”¨æˆ¶é»æ“Šã€Œå‰µå»ºè¨±é¡˜å–®ã€æŒ‰éˆ•
    â†“
é€²å…¥ /create é é¢
    â†“
ç”¨æˆ¶å¡«å¯«è¡¨å–®ä¸¦é»æ“Šã€Œå‰µå»ºè¨±é¡˜å–®ã€
    â†“
handleSubmit() åŸ·è¡Œ
    â†“
requireAuth('/create') æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    â†“
æœªç™»å…¥ âŒ
    â†“
router.push('/login?next=/create')
    â†“
LoginScreen é¡¯ç¤ºï¼ˆå¸¶ next åƒæ•¸ï¼‰
    â†“
ç”¨æˆ¶è¼¸å…¥å¸³å¯†ä¸¦ç™»å…¥
    â†“
ç™»å…¥æˆåŠŸ
    â†“
navigateAfterLogin('/create')
    â†“
router.replace('/create')
    â†“
å›åˆ°å‰µå»ºé é¢ï¼Œç”¨æˆ¶å¯ç¹¼çºŒæ“ä½œ
```

### å ´æ™¯ 2ï¼šæœªç™»å…¥ç”¨æˆ¶é»æ“Šã€Œæˆ‘è¦å›è¦†/å ±åƒ¹ã€

```
ç”¨æˆ¶åœ¨ wish è©³æƒ…é é»æ“Šã€Œæˆ‘è¦å›è¦†/å ±åƒ¹ã€
    â†“
é€²å…¥ /wish/[id]/reply é é¢
    â†“
ç”¨æˆ¶è¼¸å…¥è¨Šæ¯ä¸¦é»æ“Šã€Œé€å‡ºã€
    â†“
handleSubmit() åŸ·è¡Œ
    â†“
requireAuth(`/wish/${id}/reply`) æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    â†“
æœªç™»å…¥ âŒ
    â†“
router.push('/login?next=/wish/${id}/reply')
    â†“
LoginScreen é¡¯ç¤ºï¼ˆå¸¶ next åƒæ•¸ï¼‰
    â†“
ç”¨æˆ¶è¼¸å…¥å¸³å¯†ä¸¦ç™»å…¥
    â†“
ç™»å…¥æˆåŠŸ
    â†“
navigateAfterLogin(`/wish/${id}/reply`)
    â†“
router.replace(`/wish/${id}/reply`)
    â†“
å›åˆ°å›è¦†é é¢ï¼Œç”¨æˆ¶å¯ç¹¼çºŒæ“ä½œ
```

### å ´æ™¯ 3ï¼šå·²ç™»å…¥ç”¨æˆ¶æ“ä½œ

```
ç”¨æˆ¶é»æ“Šã€Œå‰µå»ºè¨±é¡˜å–®ã€æˆ–ã€Œé€å‡ºå›è¦†ã€
    â†“
handleSubmit() åŸ·è¡Œ
    â†“
requireAuth() æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    â†“
å·²ç™»å…¥ âœ…
    â†“
è¿”å› true
    â†“
ç¹¼çºŒåŸ·è¡Œå¾ŒçºŒé‚è¼¯ï¼ˆå‰µå»º wish æˆ–é€å‡ºå›è¦†ï¼‰
```

## ğŸ›¡ï¸ ä¿è­·çš„å¯«å…¥æ“ä½œ

### âœ… å·²å¯¦ç¾ Auth Gate

1. **ç™¼éœ€æ±‚ï¼ˆå‰µå»º Wishï¼‰**
   - ä½ç½®ï¼š`app/create.tsx`
   - æª¢æŸ¥é»ï¼š`handleSubmit()` é–‹å§‹æ™‚
   - ç›®æ¨™è·¯ç”±ï¼š`/create`

2. **å›è¦†/å ±åƒ¹ï¼ˆReply/Offerï¼‰**
   - ä½ç½®ï¼š`app/wish/[id]/reply.tsx`
   - æª¢æŸ¥é»ï¼š`handleSubmit()` é–‹å§‹æ™‚
   - ç›®æ¨™è·¯ç”±ï¼š`/wish/${id}/reply`

### ğŸ“ å¾…å¯¦ç¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

3. **ç§è¨Šé€å‡º**
   - å¦‚æœ App ä¸­æœ‰ç§è¨ŠåŠŸèƒ½ï¼Œéœ€è¦åœ¨ç™¼é€è¨Šæ¯çš„ handler ä¸­æ·»åŠ  `requireAuth()`

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### requireAuth() å‡½æ•¸

```typescript
export async function requireAuth(nextRoute: string): Promise<boolean> {
  const session = await getSession();
  
  if (!session) {
    // æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é ä¸¦ä¿å­˜ç›®æ¨™è·¯ç”±
    const encodedRoute = encodeURIComponent(nextRoute);
    router.push(`/login?next=${encodedRoute}`);
    return false;
  }
  
  // å·²ç™»å…¥
  return true;
}
```

### ä½¿ç”¨ç¯„ä¾‹

```typescript
const handleSubmit = async () => {
  // é©—è­‰è¼¸å…¥...
  
  // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
  const isAuthenticated = await requireAuth('/create');
  if (!isAuthenticated) {
    // æœªç™»å…¥ï¼Œå·²å°å‘ç™»å…¥é ï¼Œç›´æ¥è¿”å›
    return;
  }
  
  // å·²ç™»å…¥ï¼Œç¹¼çºŒåŸ·è¡Œ...
};
```

### ç™»å…¥å¾Œå›è·³

```typescript
// login.tsx
const { next } = useLocalSearchParams<{ next?: string }>();

// ç™»å…¥æˆåŠŸå¾Œ
navigateAfterLogin(next); // è‡ªå‹•è™•ç† next åƒæ•¸
```

## âœ… é©—æ”¶æ¸¬è©¦

### æ¸¬è©¦å ´æ™¯ 1ï¼šæœªç™»å…¥é»ã€Œé€å‡ºå›è¦†ã€
- [x] æœªç™»å…¥ç‹€æ…‹ä¸‹é»æ“Šã€Œæˆ‘è¦å›è¦†/å ±åƒ¹ã€
- [x] é€²å…¥å›è¦†é é¢
- [x] è¼¸å…¥è¨Šæ¯ä¸¦é»æ“Šã€Œé€å‡ºã€
- [x] è‡ªå‹•è·³è½‰åˆ°ç™»å…¥é ï¼ˆURL åŒ…å« `next=/wish/xxx/reply`ï¼‰
- [x] ç™»å…¥æˆåŠŸå¾Œè‡ªå‹•å›åˆ°å›è¦†é 
- [x] å¯ä»¥ç¹¼çºŒæ“ä½œï¼ˆè¡¨å–®å…§å®¹å¯èƒ½å·²æ¸…ç©ºï¼Œé€™æ˜¯æ­£å¸¸è¡Œç‚ºï¼‰

### æ¸¬è©¦å ´æ™¯ 2ï¼šæœªç™»å…¥é»ã€Œç™¼éœ€æ±‚ã€
- [x] æœªç™»å…¥ç‹€æ…‹ä¸‹é»æ“Šã€Œå‰µå»ºè¨±é¡˜å–®ã€
- [x] é€²å…¥å‰µå»ºé é¢
- [x] å¡«å¯«è¡¨å–®ä¸¦é»æ“Šã€Œå‰µå»ºè¨±é¡˜å–®ã€
- [x] è‡ªå‹•è·³è½‰åˆ°ç™»å…¥é ï¼ˆURL åŒ…å« `next=/create`ï¼‰
- [x] ç™»å…¥æˆåŠŸå¾Œè‡ªå‹•å›åˆ°å‰µå»ºé 
- [x] å¯ä»¥ç¹¼çºŒæ“ä½œï¼ˆè¡¨å–®å…§å®¹å¯èƒ½å·²æ¸…ç©ºï¼Œé€™æ˜¯æ­£å¸¸è¡Œç‚ºï¼‰

### æ¸¬è©¦å ´æ™¯ 3ï¼šå·²ç™»å…¥æ“ä½œ
- [x] å·²ç™»å…¥ç‹€æ…‹ä¸‹é»æ“Šã€Œå‰µå»ºè¨±é¡˜å–®ã€æˆ–ã€Œé€å‡ºå›è¦†ã€
- [x] ç›´æ¥åŸ·è¡Œæ“ä½œï¼Œä¸éœ€è¦ç™»å…¥

## ğŸ“ æ³¨æ„äº‹é …

1. **è¡¨å–®å…§å®¹å¯èƒ½æ¸…ç©º**
   - ç•¶ç”¨æˆ¶å¾ç™»å…¥é è¿”å›æ™‚ï¼ŒReact çµ„ä»¶æœƒé‡æ–°æ¸²æŸ“
   - å¦‚æœéœ€è¦åœ¨ç™»å…¥å¾Œä¿ç•™è¡¨å–®å…§å®¹ï¼Œå¯ä»¥ä½¿ç”¨ï¼š
     - AsyncStorage ä¿å­˜è¡¨å–®è‰ç¨¿
     - æˆ–ä½¿ç”¨ Context/State Management

2. **URL ç·¨ç¢¼**
   - `requireAuth()` ä½¿ç”¨ `encodeURIComponent()` ç·¨ç¢¼è·¯ç”±
   - `navigateAfterLogin()` ä½¿ç”¨ `decodeURIComponent()` è§£ç¢¼
   - ç¢ºä¿ç‰¹æ®Šå­—ç¬¦æ­£ç¢ºè™•ç†

3. **è·¯ç”±é©—è­‰**
   - `navigateAfterLogin()` ä¸­æœ‰åŸºæœ¬çš„è·¯ç”±æ ¼å¼é©—è­‰
   - é˜²æ­¢è·¯å¾‘éæ­·æ”»æ“Šï¼ˆå¿…é ˆä»¥ `/` é–‹é ­ï¼Œä¸èƒ½æ˜¯ `//`ï¼‰

4. **éŒ¯èª¤è™•ç†**
   - æ‰€æœ‰å‡½æ•¸éƒ½æœ‰ try-catch
   - ç™¼ç”ŸéŒ¯èª¤æ™‚è‡³å°‘å°èˆªåˆ°é¦–é ï¼Œé¿å… App å¡ä½








