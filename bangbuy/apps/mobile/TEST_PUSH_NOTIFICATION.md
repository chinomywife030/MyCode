# 📱 推送通知測試指南

## 🎯 測試目標

驗證「新增回覆/報價」事件的推送通知功能：
- 當有人回覆願望單時，owner 會收到推送通知
- 點擊推送通知可以深鏈接到對應的 `/wish/[id]` 頁面

## 📋 測試方法

### 方法 1：使用兩台設備（最簡單）⭐ 推薦

#### 準備工作
1. **設備 A（帳號 A）**：
   - 登入帳號 A
   - 確保已授予推送通知權限
   - 創建一個 wish

2. **設備 B（帳號 B）**：
   - 登入帳號 B
   - 找到帳號 A 創建的 wish
   - 對該 wish 發送回覆

#### 測試步驟
1. 在設備 A 上創建一個 wish，記下 wish ID
2. 在設備 B 上找到該 wish，點擊「我要回覆/報價」
3. 輸入回覆內容並送出
4. **檢查設備 A**：應該收到推送通知
5. **點擊推送通知**：應該自動打開 App 並導航到對應的 wish 詳情頁

---

### 方法 2：同一設備切換帳號

#### 準備工作
1. 準備兩個測試帳號（帳號 A 和帳號 B）
2. 在 Supabase Dashboard 或 Web 端創建帳號（如果 App 沒有註冊功能）

#### 測試步驟

**步驟 1：使用帳號 A**
1. 在手機上登入帳號 A
2. 確保已授予推送通知權限
3. 創建一個 wish，記下 wish ID
4. 保持 App 打開（或關閉 App，但確保通知權限已授予）

**步驟 2：切換到帳號 B**
1. 清除 App 資料或重新安裝 App（清除登入狀態）
2. 登入帳號 B
3. 找到帳號 A 創建的 wish
4. 對該 wish 發送回覆

**步驟 3：檢查推送通知**
1. 切換回帳號 A（或使用另一台設備登入帳號 A）
2. 應該收到推送通知
3. 點擊推送通知測試深鏈接

---

### 方法 3：使用 Web 端 + 手機端

#### 準備工作
1. **Web 端（帳號 A）**：
   - 在瀏覽器登入 `https://bangbuy.app`
   - 創建一個 wish

2. **手機端（帳號 B）**：
   - 登入帳號 B
   - 找到帳號 A 創建的 wish
   - 發送回覆

#### 測試步驟
1. 在 Web 端創建 wish
2. 在手機端找到該 wish 並發送回覆
3. **注意**：Web 端不會收到推送通知（推送通知僅支援移動設備）
4. 如果帳號 A 也在手機上登入，應該會收到推送通知

---

### 方法 4：使用測試工具（開發用）

#### 使用測試 API
可以直接呼叫測試 API 發送推送通知：

```bash
curl -X POST https://bangbuy.app/api/push/test \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "帳號A的用戶ID",
    "title": "測試推播",
    "body": "這是一則測試推播通知"
  }'
```

或使用測試頁面：
- 訪問 `https://bangbuy.app/test-push`
- 輸入用戶 ID 和推播內容
- 點擊「發送測試推播」

---

## ✅ 驗收檢查清單

測試時請確認以下項目：

- [ ] **回覆功能正常**：可以成功送出回覆
- [ ] **推送通知收到**：owner 的手機收到推送通知
- [ ] **推送內容正確**：
  - 標題為「有人回覆你的需求」
  - 內容為回覆的前 30 字
- [ ] **深鏈接正常**：點擊推送通知可以打開 App
- [ ] **導航正確**：點擊後自動導航到對應的 `/wish/[id]` 頁面
- [ ] **不會重複推送**：自己回覆自己的 wish 不會收到推送

---

## 🔍 調試技巧

### 檢查 Push Token 是否註冊

在 Supabase Dashboard 中查詢：
```sql
SELECT * FROM device_tokens 
WHERE user_id = '你的用戶ID'
ORDER BY last_seen_at DESC;
```

### 檢查回覆是否建立

```sql
SELECT * FROM wish_replies 
WHERE wish_id = 'wish的ID'
ORDER BY created_at DESC;
```

### 查看後端日誌

如果使用 Vercel：
1. 登入 Vercel Dashboard
2. 選擇專案
3. 查看 Functions 日誌
4. 搜尋 `[POST /api/replies/create]` 相關日誌

### 查看 App 日誌

在 Expo 開發工具中：
- 查看終端輸出
- 搜尋 `[createWishReply]` 相關日誌
- 搜尋 `[registerPushToken]` 相關日誌

---

## 🐛 常見問題

### 1. 沒有收到推送通知

**可能原因**：
- Push token 未註冊
- 通知權限未授予
- 後端 API 調用失敗
- 自己回覆自己的 wish（不會觸發推送）

**解決方法**：
1. 檢查 `device_tokens` 表中是否有該用戶的 token
2. 確認手機已授予通知權限
3. 檢查後端日誌是否有錯誤
4. 使用測試 API 直接發送推送測試

### 2. 推送通知收到但點擊無反應

**可能原因**：
- 深鏈接處理器未正確設定
- App 未正確處理推送通知點擊事件

**解決方法**：
1. 檢查 `src/lib/push.ts` 中的 `handleNotificationResponse` 函式
2. 確認推送通知的 `data` 欄位包含 `wishId` 或 `url`
3. 查看 App 日誌中的 `[handleNotificationResponse]` 相關訊息

### 3. API 調用失敗

**可能原因**：
- 後端服務未運行
- URL 配置錯誤
- 網路連線問題

**解決方法**：
1. 確認 `EXPO_PUBLIC_API_BASE_URL` 配置正確
2. 檢查後端服務是否正常運行
3. 查看 App 日誌中的 API 調用錯誤訊息
4. 如果 API 不可用，會自動回退到直接寫入 Supabase（功能仍可用，但不會觸發推送）

---

## 📝 測試記錄模板

```
測試日期：___________
測試人員：___________

測試環境：
- 設備 A：___________
- 帳號 A：___________
- 設備 B：___________
- 帳號 B：___________

測試結果：
- [ ] 回覆功能正常
- [ ] 推送通知收到
- [ ] 推送內容正確
- [ ] 深鏈接正常
- [ ] 導航正確

問題記錄：
___________
___________
```

---

## 🎉 成功標準

測試成功的標準：
1. ✅ 可以成功送出回覆
2. ✅ Owner 收到推送通知
3. ✅ 點擊推送通知可以打開 App 並導航到正確的頁面
4. ✅ 不會收到重複或不必要的推送通知






