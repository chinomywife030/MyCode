<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BangBuy - é‡è¨­å¯†ç¢¼</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: #f4f4f5;
      padding: 20px;
    }

    .card {
      width: 100%;
      max-width: 400px;
      background: white;
      padding: 40px 30px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .logo {
      font-size: 32px;
      font-weight: bold;
      color: #0066CC;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 30px;
    }

    .status-message {
      font-size: 16px;
      color: #666;
      margin: 20px 0;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .status-message.error {
      color: #d32f2f;
      background: #ffebee;
    }

    .status-message.success {
      color: #2e7d32;
      background: #e8f5e9;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #0066CC;
    }

    .form-input.error {
      border-color: #d32f2f;
    }

    .error-text {
      font-size: 12px;
      color: #d32f2f;
      margin-top: 4px;
      display: block;
    }

    .password-toggle {
      position: relative;
    }

    .password-toggle-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
    }

    .password-toggle-btn:hover {
      color: #0066CC;
    }

    .btn {
      width: 100%;
      padding: 14px;
      background: #0066CC;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
      margin-top: 10px;
    }

    .btn:hover:not(:disabled) {
      background: #0052a3;
    }

    .btn:active:not(:disabled) {
      transform: scale(0.98);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .success-icon {
      font-size: 64px;
      color: #2e7d32;
      margin-bottom: 20px;
    }

    .hidden {
      display: none;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0066CC;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 480px) {
      .card {
        padding: 30px 20px;
      }

      .logo {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- Logo -->
    <div class="logo">BangBuy</div>
    <div class="subtitle">å¹«è²·</div>

    <!-- ç‹€æ…‹ 1: æ­£åœ¨é©—è­‰é€£çµ -->
    <div id="verifying-state">
      <div class="status-message">
        <div class="loading"></div>
        æ­£åœ¨é©—è­‰é€£çµ...
      </div>
    </div>

    <!-- ç‹€æ…‹ 2: é©—è­‰å¤±æ•—/éŒ¯èª¤ -->
    <div id="error-state" class="hidden">
      <div class="status-message error">
        <strong>é©—è­‰å¤±æ•—</strong>
        <p id="error-message" style="margin-top: 8px; font-size: 14px;"></p>
      </div>
    </div>

    <!-- ç‹€æ…‹ 3: è¼¸å…¥æ–°å¯†ç¢¼è¡¨å–® -->
    <div id="form-state" class="hidden">
      <h2 style="font-size: 20px; color: #333; margin-bottom: 24px;">è¨­å®šæ–°å¯†ç¢¼</h2>
      
      <form id="reset-form">
        <div class="form-group">
          <label class="form-label" for="new-password">æ–°å¯†ç¢¼</label>
          <div class="password-toggle">
            <input
              type="password"
              id="new-password"
              class="form-input"
              placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘ 6 å€‹å­—å…ƒï¼‰"
              required
              minlength="6"
            />
            <button
              type="button"
              class="password-toggle-btn"
              onclick="togglePassword('new-password', this)"
            >
              ğŸ‘ï¸
            </button>
          </div>
          <span id="new-password-error" class="error-text hidden"></span>
        </div>

        <div class="form-group">
          <label class="form-label" for="confirm-password">ç¢ºèªæ–°å¯†ç¢¼</label>
          <div class="password-toggle">
            <input
              type="password"
              id="confirm-password"
              class="form-input"
              placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼"
              required
              minlength="6"
            />
            <button
              type="button"
              class="password-toggle-btn"
              onclick="togglePassword('confirm-password', this)"
            >
              ğŸ‘ï¸
            </button>
          </div>
          <span id="confirm-password-error" class="error-text hidden"></span>
        </div>

        <button type="submit" class="btn" id="submit-btn">
          æ›´æ–°å¯†ç¢¼
        </button>
      </form>
    </div>

    <!-- ç‹€æ…‹ 4: æˆåŠŸ -->
    <div id="success-state" class="hidden">
      <div class="success-icon">âœ“</div>
      <h2 style="font-size: 20px; color: #2e7d32; margin-bottom: 12px;">å¯†ç¢¼ä¿®æ”¹æˆåŠŸ</h2>
      <p style="font-size: 14px; color: #666; margin-bottom: 24px;">
        æ‚¨çš„å¯†ç¢¼å·²æˆåŠŸæ›´æ–°ï¼Œè«‹è¿”å› App ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥ã€‚
      </p>
    </div>
  </div>

  <script>
    // ============================================
    // Supabase é…ç½®
    // ============================================
    // è«‹å°‡ä»¥ä¸‹å…©å€‹è®Šæ•¸æ›¿æ›ç‚ºæ‚¨çš„ Supabase å°ˆæ¡ˆè³‡è¨Š
    // å¯ä»¥åœ¨ Supabase Dashboard > Settings > API ä¸­æ‰¾åˆ°
    const SUPABASE_URL = 'https://iaizclcplchjhbfafkiy.supabase.co'; // ä¾‹å¦‚: 'https://xxxxx.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhaXpjbGNwbGNoamhiZmFma2l5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0Mzg0ODMsImV4cCI6MjA4MDAxNDQ4M30.mKrm8yObbrpTZvt5Qp90mNy638qGPEjYtxHu_7cLTiI'; // ä¾‹å¦‚: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'

    // å¦‚æœè®Šæ•¸ç‚ºç©ºï¼Œé¡¯ç¤ºéŒ¯èª¤
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      showError('è«‹åœ¨ HTML æª”æ¡ˆä¸­è¨­å®š SUPABASE_URL å’Œ SUPABASE_ANON_KEY');
    }

    // åˆå§‹åŒ– Supabase Client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        detectSessionInUrl: true,
        persistSession: false,
      },
    });

    // ============================================
    // ç‹€æ…‹ç®¡ç†
    // ============================================
    const states = {
      verifying: document.getElementById('verifying-state'),
      error: document.getElementById('error-state'),
      form: document.getElementById('form-state'),
      success: document.getElementById('success-state'),
    };

    function showState(stateName) {
      Object.values(states).forEach(state => state.classList.add('hidden'));
      if (states[stateName]) {
        states[stateName].classList.remove('hidden');
      }
    }

    function showError(message) {
      document.getElementById('error-message').textContent = message;
      showState('error');
    }

    // ============================================
    // å¯†ç¢¼é¡¯ç¤º/éš±è—åˆ‡æ›
    // ============================================
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'ğŸ™ˆ';
      } else {
        input.type = 'password';
        button.textContent = 'ğŸ‘ï¸';
      }
    }

    // ============================================
    // è¡¨å–®é©—è­‰
    // ============================================
    function validateForm() {
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      let isValid = true;

      // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤
      document.getElementById('new-password-error').classList.add('hidden');
      document.getElementById('confirm-password-error').classList.add('hidden');
      document.getElementById('new-password').classList.remove('error');
      document.getElementById('confirm-password').classList.remove('error');

      // é©—è­‰æ–°å¯†ç¢¼é•·åº¦
      if (newPassword.length < 6) {
        document.getElementById('new-password-error').textContent = 'å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ';
        document.getElementById('new-password-error').classList.remove('hidden');
        document.getElementById('new-password').classList.add('error');
        isValid = false;
      }

      // é©—è­‰å…©æ¬¡è¼¸å…¥æ˜¯å¦ä¸€è‡´
      if (newPassword !== confirmPassword) {
        document.getElementById('confirm-password-error').textContent = 'å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´';
        document.getElementById('confirm-password-error').classList.remove('hidden');
        document.getElementById('confirm-password').classList.add('error');
        isValid = false;
      }

      return isValid;
    }

    // ============================================
    // æ›´æ–°å¯†ç¢¼
    // ============================================
    async function updatePassword(newPassword) {
      try {
        const { error } = await supabase.auth.updateUser({
          password: newPassword,
        });

        if (error) throw error;

        // æˆåŠŸ
        showState('success');
      } catch (error) {
        console.error('Update password error:', error);
        showError(error.message || 'å¯†ç¢¼æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        showState('form');
      }
    }

    // ============================================
    // è¡¨å–®æäº¤è™•ç†
    // ============================================
    document.getElementById('reset-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!validateForm()) {
        return;
      }

      const newPassword = document.getElementById('new-password').value;
      const submitBtn = document.getElementById('submit-btn');
      
      // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      submitBtn.disabled = true;
      submitBtn.textContent = 'æ›´æ–°ä¸­...';

      try {
        await updatePassword(newPassword);
      } finally {
        // æ¢å¾©æŒ‰éˆ•ï¼ˆå¦‚æœå¤±æ•—ï¼‰
        if (states.form.classList.contains('hidden')) {
          // æˆåŠŸï¼Œä¸éœ€è¦æ¢å¾©
        } else {
          submitBtn.disabled = false;
          submitBtn.textContent = 'æ›´æ–°å¯†ç¢¼';
        }
      }
    });

    // ============================================
    // Auth ç‹€æ…‹ç›£è½
    // ============================================
    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('ğŸ”” Auth Event:', event, session?.user?.id);

      if (event === 'PASSWORD_RECOVERY') {
        // åµæ¸¬åˆ°å¯†ç¢¼é‡è¨­æµç¨‹ï¼Œé¡¯ç¤ºè¡¨å–®
        console.log('âœ… PASSWORD_RECOVERY detected, showing form');
        showState('form');
      } else if (event === 'SIGNED_IN' && session) {
        // å·²ç™»å…¥ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ session
        // å¦‚æœå·²ç¶“åœ¨é‡è¨­å¯†ç¢¼æµç¨‹ä¸­ï¼Œé¡¯ç¤ºè¡¨å–®
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const type = hashParams.get('type');

        if (type === 'recovery' || accessToken) {
          console.log('âœ… Recovery token found in URL, showing form');
          showState('form');
        } else {
          // ä¸€èˆ¬ç™»å…¥ï¼Œå¯èƒ½å·²ç¶“å®Œæˆé‡è¨­å¯†ç¢¼
          console.log('â„¹ï¸ Regular sign in detected');
        }
      } else if (event === 'TOKEN_REFRESHED') {
        // Token åˆ·æ–°ï¼Œç¹¼çºŒé¡¯ç¤ºè¡¨å–®
        console.log('â„¹ï¸ Token refreshed');
      }
    });

    // ============================================
    // åˆå§‹åŒ–ï¼šæª¢æŸ¥ URL ä¸­çš„ Token
    // ============================================
    (async () => {
      try {
        // æª¢æŸ¥ URL hash ä¸­æ˜¯å¦æœ‰ recovery token
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const type = hashParams.get('type');

        if (type === 'recovery' && accessToken) {
          console.log('âœ… Recovery token found in URL hash');
          // ç­‰å¾… Supabase è™•ç† URL ä¸­çš„ token
          // onAuthStateChange æœƒè‡ªå‹•è§¸ç™¼
          setTimeout(() => {
            // å¦‚æœ 2 ç§’å¾Œé‚„æ²’æœ‰åˆ‡æ›åˆ°è¡¨å–®ï¼Œå¯èƒ½æ˜¯ token ç„¡æ•ˆ
            if (!states.form.classList.contains('hidden')) {
              return; // å·²ç¶“é¡¯ç¤ºè¡¨å–®äº†
            }
            // æª¢æŸ¥ session
            supabase.auth.getSession().then(({ data: { session } }) => {
              if (session) {
                showState('form');
              } else {
                showError('é€£çµå·²éæœŸæˆ–ç„¡æ•ˆï¼Œè«‹é‡æ–°ç”³è«‹é‡è¨­å¯†ç¢¼');
              }
            });
          }, 2000);
        } else {
          // æ²’æœ‰ recovery tokenï¼Œé¡¯ç¤ºéŒ¯èª¤
          console.log('âŒ No recovery token found');
          showError('ç„¡æ•ˆçš„é€£çµï¼Œè«‹é€é App é‡æ–°ç”³è«‹é‡è¨­å¯†ç¢¼');
        }
      } catch (error) {
        console.error('Initialization error:', error);
        showError('åˆå§‹åŒ–å¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤'));
      }
    })();
  </script>
</body>
</html>
